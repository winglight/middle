version: "3.8"

networks:
  stack:
    name: stack
    driver: bridge

volumes:
  n8n_data:
  redis_data:
  influxdb_data:

services:
  n8n:
    image: n8nio/n8n:latest
    # 生产建议固定小版本号，如 n8nio/n8n:1.72.1
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - N8N_HOST=${N8N_DOMAIN}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://${N8N_DOMAIN}
      - N8N_SECURE_COOKIE=true
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - EXECUTIONS_MODE=${EXECUTIONS_MODE}
      # Queue(Bull) 使用的 Redis 连接
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_REDIS_PASSWORD=${REDIS_PASSWORD}
      # 可选：禁用遥测
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_VERSION_NOTIFICATIONS_ENABLED=false
    depends_on:
      - redis
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - stack

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: >
      sh -c 'redis-server
      --save 20 1
      --loglevel warning
      --requirepass "$$REDIS_PASSWORD"'
    environment:
      - TZ=${TZ}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - stack
    # 不对外暴露端口，仅内网可见
    # 其它容器用 redis:6379 + 密码连接

  influxdb:
    image: influxdb:2.7
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      # 一次性初始化参数（容器首次启动时生效）
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_ADMIN_USER}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_ADMIN_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_BUCKET}
      - DOCKER_INFLUXDB_INIT_RETENTION=${INFLUXDB_RETENTION}
      # - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_INIT_ADMIN_TOKEN}  # 可选
    volumes:
      - influxdb_data:/var/lib/influxdb2
    networks:
      - stack
    # 不暴露宿主端口，仅内网 http://influxdb:8086

  cloudflared:
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - TUNNEL_TOKEN=${CF_TUNNEL_TOKEN}
    command: tunnel --no-autoupdate run
    depends_on:
      - n8n
    networks:
      - stack
    # 通过 Cloudflare 全权代理 n8n，无需在本机暴露端口
