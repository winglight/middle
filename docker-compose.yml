networks:
  stack:
    name: stack
    driver: bridge

volumes:
  n8n_data:
  redis_data:
  influxdb_data:

services:
  n8n:
    image: n8nio/n8n:latest
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - N8N_HOST=${N8N_DOMAIN}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://${N8N_DOMAIN}
      - N8N_SECURE_COOKIE=true
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - EXECUTIONS_MODE=${EXECUTIONS_MODE}
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_REDIS_PASSWORD=${REDIS_PASSWORD}
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_VERSION_NOTIFICATIONS_ENABLED=false
    depends_on:
      - redis
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - stack
    # 本机直连（仅回环），例如 http://127.0.0.1:5678
    # 注意：若保持 N8N_SECURE_COOKIE=true，本机用 HTTP 登录会失败（见下方说明）
    ports:
      - "127.0.0.1:5678:5678"

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: >
      sh -c 'redis-server
      --save 20 1
      --loglevel warning
      --requirepass "$$REDIS_PASSWORD"'
    environment:
      - TZ=${TZ}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - stack
    # 本机直连 redis-cli -h 127.0.0.1 -p 6379 -a $REDIS_PASSWORD
    ports:
      - "127.0.0.1:6379:6379"

  influxdb:
    image: influxdb:2.7
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_ADMIN_USER}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_ADMIN_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_BUCKET}
      - DOCKER_INFLUXDB_INIT_RETENTION=${INFLUXDB_RETENTION}
      # - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_INIT_ADMIN_TOKEN}
    volumes:
      - influxdb_data:/var/lib/influxdb2
    networks:
      - stack
    # 本机直连 Influx UI: http://127.0.0.1:8086
    ports:
      - "127.0.0.1:8086:8086"

  cloudflared:
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - TUNNEL_TOKEN=${CF_TUNNEL_TOKEN}
    command: tunnel --no-autoupdate run
    depends_on:
      - n8n
    networks:
      - stack
